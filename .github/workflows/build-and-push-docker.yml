name: Build Docker and Push

on:
  release:
    types: [published]
  # Allow manual runs
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: outburnltd/fume-fhir-converter

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout release tag commit
        if: ${{ github.event_name == 'release' }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          git fetch --tags --force
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            git checkout "$TAG"
            echo "Checked out tag $TAG"
          else
            echo "Tag $TAG not found after fetch"
            exit 1
          fi

      - name: Determine release version (from release)
        if: ${{ github.event_name == 'release' }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "RELEASE_VERSION=${TAG#v}" >> "$GITHUB_ENV"
          echo "Using version from release tag: ${TAG#v}"

      - name: Determine release version (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "RELEASE_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using version from package.json: $VERSION"

      - name: Validate required secrets
        run: |
          [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] && echo "Missing DOCKERHUB_USERNAME secret" && exit 1 || echo "Found DOCKERHUB_USERNAME";
          [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ] && echo "Missing DOCKER_HUB_TOKEN secret" && exit 1 || echo "Found DOCKER_HUB_TOKEN";

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build --tag "$DOCKER_IMAGE_NAME:$RELEASE_VERSION" .

      - name: Smoke test container /health
        run: |
          set -e
          docker rm -f fume_smoke_test >/dev/null 2>&1 || true
          docker run -d --name fume_smoke_test -p 42420:42420 \
            -e SERVER_PORT=42420 \
            -e FHIR_SERVER_BASE=n/a \
            -e FHIR_SERVER_AUTH_TYPE=NONE \
            -e FHIR_SERVER_TIMEOUT=30000 \
            -e FHIR_VERSION=4.0.1 \
            -e FHIR_PACKAGES='' \
            "$DOCKER_IMAGE_NAME:$RELEASE_VERSION"

          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:42420/health >/dev/null; then
              echo "Health OK"
              break
            fi
            echo "Waiting for /health... ($i/60)"
            sleep 2
            if [ "$i" -eq 60 ]; then
              echo "Container logs:"
              docker logs fume_smoke_test || true
              exit 1
            fi
          done

          docker rm -f fume_smoke_test

      - name: Push Docker image
        run: |
          docker push "$DOCKER_IMAGE_NAME:$RELEASE_VERSION"
          docker tag "$DOCKER_IMAGE_NAME:$RELEASE_VERSION" "$DOCKER_IMAGE_NAME:latest"
          docker push "$DOCKER_IMAGE_NAME:latest"
