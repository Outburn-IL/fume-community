name: Build Docker and Push

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v0.10.0, v1.0.0, etc.
  # Allow manual runs
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: outburnltd/fume-fhir-converter

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine release version (from tag)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: |
          TAG="${{ github.ref_name }}"
          echo "RELEASE_VERSION=${TAG#v}" >> "$GITHUB_ENV"
          echo "Using version from tag: ${TAG#v}"

      - name: Determine release version (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "RELEASE_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using version from package.json: $VERSION"

      - name: Validate required secrets
        run: |
          [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] && echo "Missing DOCKERHUB_USERNAME secret" && exit 1 || echo "Found DOCKERHUB_USERNAME";
          [ -z "${{ secrets.DOCKER_HUB_TOKEN }}" ] && echo "Missing DOCKER_HUB_TOKEN secret" && exit 1 || echo "Found DOCKER_HUB_TOKEN";

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build --tag "$DOCKER_IMAGE_NAME:$RELEASE_VERSION" .

      - name: Push Docker image
        run: |
          docker push "$DOCKER_IMAGE_NAME:$RELEASE_VERSION"
          docker tag "$DOCKER_IMAGE_NAME:$RELEASE_VERSION" "$DOCKER_IMAGE_NAME:latest"
          docker push "$DOCKER_IMAGE_NAME:latest"
