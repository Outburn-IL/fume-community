name: Notify Downstream

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send repository dispatch to downstream
        env:
          DOWNSTREAM_WEBHOOK_URL: ${{ secrets.DOWNSTREAM_WEBHOOK_URL }}
          DOWNSTREAM_TOKEN: ${{ secrets.DOWNSTREAM_TOKEN }}
          SOURCE_REF: ${{ github.event.release.tag_name }}
          SOURCE_SHA: ${{ github.sha }}
          RELEASE_ID: ${{ github.event.release.id }}
        run: |
          set -euo pipefail

          if [ -z "${DOWNSTREAM_WEBHOOK_URL}" ] || [ -z "${DOWNSTREAM_TOKEN}" ]; then
            echo "Required secrets are missing: DOWNSTREAM_WEBHOOK_URL and/or DOWNSTREAM_TOKEN"
            exit 1
          fi

          response_file="$(mktemp)"
          http_code="$(curl -sS -o "${response_file}" -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${DOWNSTREAM_TOKEN}" \
            -H "Content-Type: application/json" \
            "${DOWNSTREAM_WEBHOOK_URL}" \
            -d @- <<EOF
          {
            "event_type": "source-updated",
            "client_payload": {
              "source_ref": "${SOURCE_REF}",
              "sha": "${SOURCE_SHA}",
              "release_id": ${RELEASE_ID}
            }
          }
          EOF
          )"

          if [ "${http_code}" = "204" ]; then
            echo "Repository dispatch sent successfully"
            exit 0
          fi

          echo "Repository dispatch failed with status ${http_code}"
          if [ -s "${response_file}" ]; then
            echo "Response body:"
            cat "${response_file}"
          fi
          exit 1
